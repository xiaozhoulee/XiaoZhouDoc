# 第06节：后台代码讲解

### 一、拦截器

在项目中，前台获取数据时，需要前台提供token信息，后台验证才可以获取数据，验证代码如下。

``` js

// 在router中请求中使用中间件


  router.get('/getclazz', app.middleware.checktoken(),controller.clazz.get);

// app/milldeware/checktoken.js

// 检验前台的请求头中是否存在token
module.exports = () => {
    return async function (ctx, next) {
        if (ctx.request.header['token']) {
            await next();
        } else {
            ctx.status = 401;
            ctx.body = {
                message: '没有token'
            }
            return;
        }
    }
  };
```

### 二、后台生成token

在登录时，后台需要生成token返回给前端，生成token代码如下：
``` js
          const token = this.app.jwt.sign({ username:username }, this.app.config.jwt.secret);
```

### 三、查询数据

``` js

// 联查表中的数据

const studentList = awathis.app.model.Students.findAll({
    include: [{  
        model: this.app.model.Clazz,
         as: 'clazz'
    }]
});


```

### 四、增加数据

在前端完成增加班级或学生的时候，后台要接受前端的数据，并将它传到数据库里面，具体代码如下所示：

``` js
// 获取前端传的页面
     let name = this.ctx.request.body.name;
    const clazz = {
        clazzname: name
    }
    //添加至数据库
    await this.app.model.Clazz.creat(clazz);

```

### 五、删除数据

前端在完成删除的时候，后台需要删除对应id的数据库里面的数据，再传给前端，删除代码如下：

``` js
// 获取对应的id
    let id = this.ctx.params.id
    // 查询需要删除的学生名
    const student = awaithis.app.model.Students.findOne({
        where: {
            id: id
        }
    })
    // 删除
    student.destroy()

```

### 六、修改数据

前端执行修改点击时，后台需要获取前端对应的id以及修改的信息，修改后传到数据库里，再返回给前端，代码如下所示：
``` js
// 获取对应的id
    let id = this.ctx.params.id
// 获取需要修改的值
    let putclazzname =   this.ctx.request.body.putclazzname
// 修改值
    let row = {
        clazzname: putclazzname
    },
        options = {
            where: {
                id: id
            }
        }
// 返回给数据库
    await this.app.model.Clazz.update(row, options);
```