# 第05节：微信支付

### 一、概述

如果需要实现微信支付功能，需要有一个已认证的微信服务号，并且开通微信支付，开通后微信会提供一个商户ID。有了这个ID才能成功调用微信支付接口。

开通微信支付后，需要在微信支付后台【产品中心】=>【开发配置】中配置【JSAPI支付授权目录】和【Native支付回调链接】，如下图所示：

![](/images/1505_open05.png)

微信支付可以分为两种情况，微信浏览器之外的扫码支付（需要配置Native支付回调链接，支付完成后，微信服务器会调用这个链接，并传入参数。）和微信浏览器之内直接支付（需要配置JSAPI支付授权目录，只有这个域名下的链接才能调用支付接口）。两种支付都需要调用【统一下单接口】。所以本节针对统一下单接口来分别讲解如何实现这两种支付方法。

### 一、统一下单接口

通过调用下面的统一下单接口，就可以实现微信支付功能。

```
https://api.mch.weixin.qq.com/pay/unifiedorder
```

统一下单接口需要传入的参数包括如下内容（以下为必填项），并且参数要为xml格式：

1. appid：公众号id
2. body：商品描述
3. mch_id：商户号id
4. nonce_str：随机字符串
5. notify_url：异步接收微信支付结果通知的回调地址，通知url必须为外网可访问的url，不能携带参数。
6. openid：用户标识
7. out_trade_no：商户订单号
8. spbill_create_ip：终端IP
9. total_fee：订单总金额，单位为分
10. trade_type：交易类型JSAPI 、NATIVE、APP
11. sign：签名

获取签名的规则与之前JS-SDK的签名规则相同，字段除了上述1-10十个字段外，还需要添加一个微信商户后台获取的key（【账户中心】=》【API安全】获取）

### 二、统一下单接口的返回值

#### 交易类型为【JSAPI】

返回的xml格式会包含一个prepay_id。然后将这个值传递给前端，再由前端调用jsapi完成支付，示例代码如下所示：

``` js
document.querySelector(".pay").onclick = function(){
    function onBridgeReady() {
        WeixinJSBridge.invoke(
            'getBrandWCPayRequest', {
                "appId": `{{appId}}`, //公众号名称，由商户传入
                "timeStamp": `{{timeStamp}}`, //时间戳，自1970年以来的秒数
                "nonceStr": `{{nonceStr}}`, //随机串
                "package": `{{package}}`,
                "signType": `{{signType}}`, //微信签名方式：
                "paySign": `{{paySign}}` //微信签名
            },
            function (res) {
                if (res.err_msg == "get_brand_wcpay_request:ok") {
                    // 使用以上方式判断前端返回,微信团队郑重提示：
                    //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
                    location.href="/success"
                }
            });
    }
    if (typeof WeixinJSBridge == "undefined") {
        if (document.addEventListener) {
            document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
        } else if (document.attachEvent) {
            document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
            document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
        }
    } else {
        onBridgeReady();
    }
}
```

#### 交易类型为【NATIVE】

返回的结果包括一个code_url字段，将这个字段的值传递给前端，然后转换成二维码，用户扫码即刻完成支付。

### 三、完成支付

完成支付后，微信服务器会向notify_url的参数地址发送一个支付结果的消息。网站或公众号程序可以根据返回结果，自行处理支付完成后的业务逻辑。